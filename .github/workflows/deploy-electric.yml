name: Deploy Electric

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (dev or prod)'
        required: true
        default: dev
        type: choice
        options:
          - dev
          - prod

env:
  EKS_CLUSTER: gambly-eks-prod
  AWS_REGION: us-east-2

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENVIRONMENT="${{ inputs.environment }}"
          elif [ "${{ github.ref_name }}" = "main" ]; then
            ENVIRONMENT="prod"
          else
            ENVIRONMENT="dev"
          fi

          echo "environment=${ENVIRONMENT}" >> "$GITHUB_OUTPUT"
          echo "namespace=gambly-${ENVIRONMENT}" >> "$GITHUB_OUTPUT"

      - name: Check if deployment is configured
        id: gate
        run: |
          if [ "${{ steps.env.outputs.environment }}" = "prod" ] && grep -q 'REPLACE_ME' "k8s/prod/pv.yaml"; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=Prod EFS placeholders are still present in k8s/prod/pv.yaml" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "reason=Deployment configured" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure AWS credentials
        if: steps.gate.outputs.skip != 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.DEPLOYER_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.DEPLOYER_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download environment file
        if: steps.gate.outputs.skip != 'true'
        run: |
          aws s3 cp "s3://gambly-env/${{ steps.env.outputs.environment }}/gambly-electric.env" .env

      - name: Install kubectl
        if: steps.gate.outputs.skip != 'true'
        uses: azure/setup-kubectl@v4

      - name: Update EKS kubeconfig
        if: steps.gate.outputs.skip != 'true'
        run: |
          aws eks update-kubeconfig --region "${{ env.AWS_REGION }}" --name "${{ env.EKS_CLUSTER }}"

      - name: Apply Kubernetes manifests
        if: steps.gate.outputs.skip != 'true'
        run: |
          NAMESPACE="${{ steps.env.outputs.namespace }}"
          MANIFEST_DIR="k8s/${{ steps.env.outputs.environment }}"

          kubectl create secret generic gambly-electric-env \
            --namespace "$NAMESPACE" \
            --from-env-file=.env \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl apply -f "${MANIFEST_DIR}/csidriver-efs.yaml"
          kubectl apply -f "${MANIFEST_DIR}/pv.yaml"
          kubectl apply -f "${MANIFEST_DIR}/pvc.yaml"
          kubectl apply -f "${MANIFEST_DIR}/deployment.yaml"
          kubectl apply -f "${MANIFEST_DIR}/service.yaml"
          kubectl apply -f "${MANIFEST_DIR}/ingress.yaml"

      - name: Verify rollout
        if: steps.gate.outputs.skip != 'true'
        run: |
          kubectl rollout status deployment/gambly-electric -n "${{ steps.env.outputs.namespace }}" --timeout=5m

      - name: Print status
        if: steps.gate.outputs.skip != 'true'
        run: |
          kubectl get deploy,pod,svc,ingress -n "${{ steps.env.outputs.namespace }}" -l app=gambly-electric

      - name: Skip summary
        if: steps.gate.outputs.skip == 'true'
        run: |
          echo "Skipping deploy: ${{ steps.gate.outputs.reason }}"
